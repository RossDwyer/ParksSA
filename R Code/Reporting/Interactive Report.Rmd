---
title: "Interactive report for inspecting model outputs"
author: "Ross Dwyer"
date: '2022-04-13'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This is an R Markdown document that visualises the conservation benefits of no take protected areas to 10 teleost and elasmobranch species based on individual movements and relative abundances. The MPA size decision support model was originally developed by Dr Nils Krueck (UTAS) and published here - <https://conbio.onlinelibrary.wiley.com/doi/10.1111/conl.12415>. Dr Ross Dwyer (USC) and Dr Nils Krueck then adapted this modelling framework to allow telemetry and BRUV datasets to be included as model inputs. The original paper was published here - <https://www.sciencedirect.com/science/article/pii/S0960982219316008?via%3Dihub>. 

In this report, we apply this modelling framework to 6 teleost, three shark and one ray species to investigate the conservation effectiveness of existing no take reserves in South Australia using the following metrics. Project is a collaboration with Prof Charlie Huveneers (Flinders) and South Australia Government's Department for Environment and Water.


```{r, echo=FALSE,results='hide', message=FALSE, warning=FALSE}
# 1. Load the packages -----------
library(rgdal)
library(rgeos)
library(sp)
library(sf)
library(rmapshaper)
library(magrittr)
library(ggplot2)
library(plotly)
library(rmapshaper)
library(tmap)
library(stringr)
library(dplyr)
library(matrixStats)
```


```{r, echo=FALSE}
# Full address of the R Studio Project where data and R code are stored (needed for reproducing markdown report)
maindir <- "/Users/rdwyer2/GitHub/ParksSA/" 
```
First we set the model parameters

```{r, echo=FALSE}
# Set file locations
modelid <- 100 # specify model version / id
datadir <- paste0(maindir, 'Data/') 
results.folder <- 'Results/'
modelversion <- paste0("SA_MPAsizer",modelid) # What model version are we using?
resultsdir <- paste0(maindir,results.folder,modelversion,'/') # Where the Results .RDS files are stored
```

```{r}
# Set model parameters
case.study.region <- "SA_idealized"
resolution <- 100
dispersal.period <- "Weekly"
age <- "Maturity"
rBRUVcatchment <- 100
```

```{r, echo=FALSE}
scenario.name <- paste0(case.study.region,'_Res', resolution,'_',dispersal.period,'_AgeAt',age,'_rBRUV',rBRUVcatchment)

returndat <- readRDS(paste0(resultsdir,modelversion,'_',scenario.name,'_returndat.RDS'))

nona.locs <- which(!is.na(returndat)&!is.null(returndat))
returndat <- returndat[nona.locs]
nspecies <- length(returndat)
species.names <- names(returndat) 
SpeciesNames <- str_replace_all(species.names,'_',' ') # Formatted species names

age.data <- read.csv(paste0(datadir,'input_parameters_updated.csv'))
species.groups <- age.data$species.group[match(species.names,age.data$common.name)]
species.order <- order(species.groups,species.names) #species.groups,species.names) # determine order of species to plot
species.names.ordered <- species.names[species.order] # get names of species in order
ngroups <- xtabs(~species.groups)

returndat <- returndat[species.names.ordered]

#SpeciesNames <- str_replace_all(species.names.ordered,'_',' ') # Formatted species names

```


```{r, echo=FALSE}
#Load the plotting functions
source(paste0(maindir,"R Code/Reporting/Plotly MPA functions.R"))
```
# Calculate MPA size to achieve certain protection levels {.tabset}

## MPAs extending <10 km
```{r, echo=FALSE}
plotPropTim(sxaxis=10,sd=TRUE) # Plot mean protection with x axis <10 km
```

## MPAs extending <100 km
```{r, echo=FALSE}
plotPropTim(sd=TRUE) # Plot mean protection with x axis <100 km
```

# Calculate lifetime fishing mortality and fishing mortality offsets {.tabset}

## F = 0.05
```{r, echo=FALSE}
plotLifMort(F1="0.05",sd=TRUE)
```

## F = 0.1
```{r, echo=FALSE}
plotLifMort(F1="0.1",sd=TRUE)
```

## F = 0.2
```{r, echo=FALSE}
plotLifMort(F1="0.2",sd=TRUE)
```

## F = 0.5
```{r, echo=FALSE}
plotLifMort(F1="0.5",sd=TRUE)
```

# Calculate annual fishing mortality offsets  {.tabset}

## F = 0.05
```{r, echo=FALSE}
#foffs.d <- round(foffs,2) # Round to 2 decimal places for easy viewing
plotMortOff(F1="0.05")
```

## F = 0.1
```{r, echo=FALSE}
plotMortOff(F1="0.1")
```

## F = 0.2
```{r, echo=FALSE}
plotMortOff(F1="0.2")
```

## F = 0.5
```{r, echo=FALSE}
plotMortOff(F1="0.5")
```


# Calculate the probability of survival to maturity {.tabset}

## F = 0.05
```{r}
plotProbSurv(F1="0.05")
```

## F = 0.1
```{r, echo=FALSE}
plotProbSurv(F1="0.1")
```

## F = 0.2
```{r, echo=FALSE}
plotProbSurv(F1="0.2")
```

## F = 0.5
```{r, echo=FALSE}
plotProbSurv(F1="0.5")
```

# Calculate number of protected individuals {.tabset}

## F = 0.05
```{r}
plotNoInd("0.05")
```

## F = 0.1
```{r, echo=FALSE}
plotNoInd(F1="0.1")
```

## F = 0.2
```{r, echo=FALSE}
plotNoInd(F1="0.2")
```

## F = 0.5
```{r, echo=FALSE}
plotNoInd(F1="0.5")
```


# Maping South Australia's protected areas {.tabset}

This Section displays an interactive map of IUCN Cat II reserves in South Australian Waters. The dataset was sourced from the Australian Government Collaborative Australian Protected Area Database (CAPAD 2020) <https://www.awe.gov.au/agriculture-land/land/nrs/science/capad>. Areas are coloured according to (a) maximum reserve width or (b) the minimum distance between Cat II reserves. 

## Max width 
```{r, echo=FALSE}
SAMPA_CatII_nearest_sf <- readRDS(paste0(maindir,"R Code/Reporting/SAMPA_CatII_nearest.RDS"))

tmap_mode("view")
tm_shape(SAMPA_CatII_nearest_sf) + 
  tm_fill("MaxDist_km", 
          title="Maximum width of MPA (km)",
          id="NAME", 
          breaks = c(0,5,10,20,30,50,100,200),
          palette = rev(sf.colors(7)),
          popup.vars=c("Type"="TYPE",
                       "RES_NUMBER"="RES_NUMBER",
                       "Distance to nearest MPA (km)"="Nearest_km", 
                       "Max width (km)"="MaxDist_km", 
                       "Area"="GAZ_AREA"))

```

## Min distance
```{r, echo=FALSE,message=FALSE, warning=FALSE}
tm_shape(SAMPA_CatII_nearest_sf) + 
  tm_fill("Nearest_km", 
          title="Minimum distance between MPAs (km)",
          id="NAME", 
          breaks = c(0,5,10,20,40,60,80),
          palette = sf.colors(7),
          popup.vars=c("Type"="TYPE",
                       "RES_NUMBER"="RES_NUMBER",
                       "Distance to nearest MPA (km)"="Nearest_km", 
                       "Max width (km)"="MaxDist_km", 
                       "Area"="GAZ_AREA"))

```
